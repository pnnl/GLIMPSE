const getCustomTheme = async (paths) => {
  let themeData = null;

  for (let i = 0; i < paths.length; i++) {
    // Look for the theme file
    if (paths[i].split('.')[1] === 'theme') {
      // get the theme data if the file is valid against a JSON schema
      // if not valid the validateTheme function will return a object with an error message
      themeData = await window.glimpseAPI.validateTheme(paths[i]);
      paths.splice(i, 1);
      break;
    }
  }

  if (themeData && 'error' in themeData) {
    alert(themeData.error);
    return;
  }

  return themeData;
};

export const isGlmFile = (path) => path.split('.').pop() === 'glm';
const isJsonFile = (path) => path.split('.').pop() === 'json';

/**
 *
 * @param {Array} paths List of paths
 * @returns {Number | null} Returns null if the files don't contain a the numbers 123, 3000, 9500
 */
const extractModelNumber = (paths) => {
  const regex = /(123|3000|9500)/;

  for (let path of paths) {
    const match = path.match(regex);
    if (match) {
      return match[0];
    }
  }

  return null;
};

/**
 * This function will get the paths of the uploaded files and send them to the
 * main process to then read the files, parse them, and evalute them.
 * @param {Array} paths - An array of paths from the uploaded files
 */
export const handleFileUpload = async (paths, setFileData, setFilesUploaded) => {
  const selectedTheme = await window.glimpseAPI.getTheme();
  setFileData({ loading: true });

  if (paths.every(isGlmFile) && selectedTheme === 'power-grid-theme') {
    setFilesUploaded(true);
    const modelNumber = extractModelNumber(paths);
    const data = await window.glimpseAPI.glm2json(paths);

    if (!data) {
      alert('Something went wrong... \n Re-upload or reset app');
      setFilesUploaded(false);
      setFileData({ loading: false });
    } else if ('alert' in data) {
      alert(data.alert);
      setFilesUploaded(false);
      setFileData({ loading: false });
    } else {
      setFileData({
        visData: data,
        theme: await window.glimpseAPI.getThemeJsonData('PowerGrid.theme.json'),
        isGlm: true,
        loading: false,
        modelNumber: modelNumber
      });
    }
  } else if (paths.every(isJsonFile) && selectedTheme === 'custom-theme') {
    let themeData = { groups: {}, edgeOptions: {} };

    if (paths.length > 1) themeData = await getCustomTheme(paths);

    setFilesUploaded(true);
    const validFileData = JSON.parse(await window.glimpseAPI.validate(paths));

    if ('error' in validFileData) {
      setFilesUploaded(false);
      setFileData({ loading: false });
      alert(validFileData.error);
    } else {
      setFileData({
        visData: validFileData,
        theme: themeData,
        isGlm: false,
        loading: false
      });
    }
  } else {
    alert(
      'Upload glm files with the Power Grid theme or any JSON file with the custom theme selected'
    );
    setFileData({ loading: false });
  }
};
